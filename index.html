<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mijn Motivatie Booster</title>
    <!-- Tailwind CSS CDN voor snelle styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter voor een modern uiterlijk -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar voor een mooiere look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #666;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 sm:p-6 lg:p-8 flex items-center justify-center">

    <div class="max-w-4xl w-full mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-indigo-700 dark:text-indigo-400">
            Mijn Motivatie Booster
        </h1>

        <!-- Sectie voor Ambitiebeheer -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">
                Mijn Verbeter Ambities
            </h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input
                    type="text"
                    id="newAmbitionText"
                    class="flex-grow p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="Voeg een nieuwe ambitie toe..."
                />
                <select
                    id="selectedCategory"
                    class="p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                    <option value="">Kies een categorie</option>
                    <option value="Samenwerking & Connectie">Samenwerking & Connectie</option>
                    <option value="Voortgang & Feedback">Voortgang & Feedback</option>
                    <option value="Structuur & Productiviteit">Structuur & Productiviteit</option>
                    <option value="Professionele Ontwikkeling">Professionele Ontwikkeling</option>
                </select>
                <button
                    id="addAmbitionButton"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition duration-200 ease-in-out"
                >
                    Toevoegen
                </button>
            </div>
            <p id="ambitionError" class="text-red-500 text-sm mt-2 hidden">Vul zowel de ambitie als een categorie in.</p>

            <ul id="ambitionsList" class="space-y-3">
                <!-- Ambities worden hier dynamisch geladen -->
            </ul>
        </div>

        <!-- Sectie voor Virtuele Manager -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">
                Praat met je Virtuele Manager
            </h2>
            <div class="flex flex-col gap-4 mb-4">
                <textarea
                    id="chatInput"
                    class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y min-h-[100px]"
                    placeholder="Deel je voortgang, uitdagingen, of waar je over wilt praten met je virtuele manager..."
                ></textarea>
                <button
                    id="chatButton"
                    class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition duration-200 ease-in-out flex items-center justify-center"
                >
                    <span id="chatButtonText">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.504 12.53 2 11.235 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-7 4a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" />
                        </svg>
                        Vraag je Virtuele Manager
                    </span>
                    <svg id="chatSpinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <div id="chatResponseContainer" class="mt-6 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg shadow-md border border-blue-200 dark:border-blue-700 hidden">
                <h3 class="text-lg font-semibold mb-2 text-blue-800 dark:text-blue-200">
                    Antwoord van je Virtuele Manager:
                </h3>
                <p id="chatResponseText" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></p>
                <p id="audioLoadingMessage" class="text-sm text-gray-500 dark:text-gray-400 mt-2 hidden">Audio wordt geladen...</p>
                <audio id="audioPlayer" controls class="w-full mt-4"></audio>
            </div>
        </div>

        <!-- Sectie voor Motivatie Boosters -->
        <div>
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">
                Motivatie Boosters
            </h2>
            <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                <li><strong class="text-indigo-600 dark:text-indigo-300">Zoek kleine overwinningen:</strong> Deel grote doelen op in kleinere, haalbare stappen. Elke afgevinkte stap geeft een boost!</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Deel je successen:</strong> Vertel anderen over je voortgang, zelfs kleine successen. Dit kan je extra motiveren.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Visualiseer je doelen:</strong> Stel je voor hoe het voelt om je doelen te bereiken. Een helder mentaal beeld kan krachtig zijn.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Neem pauzes:</strong> Korte, regelmatige pauzes helpen je om gefocust en energiek te blijven gedurende de dag.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Vier je vooruitgang:</strong> Beloon jezelf voor mijlpalen, hoe klein ook. Dit versterkt positief gedrag.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Leer van tegenslagen:</strong> Zie fouten als leermomenten, niet als mislukkingen. Analyseer wat er misging en pas je aan.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Zoek een mentor:</strong> Iemand met meer ervaring kan waardevol advies en perspectief bieden.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Blijf nieuwsgierig:</strong> Verken nieuwe aspecten van je werk of vakgebied. Nieuwsgierigheid voedt de motivatie.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Stel realistische doelen:</strong> Onrealistische doelen leiden tot demotivatie. Zorg dat je doelen uitdagend, maar haalbaar zijn.</li>
                <li><strong class="text-indigo-600 dark:text-indigo-300">Zorg voor een goede werk-priv√©balans:</strong> Voldoende rust en ontspanning zijn essentieel om gemotiveerd en productief te blijven.</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK's -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globale variabelen voor Firebase en app-status
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'github-pages-motivation-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                // JE FIREBASE CONFIGURATIE (VAN DE FIREBASE CONSOLE)
                apiKey: "AIzaSyD0_SOJt-CoYuEtHACzrSjDrI3opZdaWvM",
                authDomain: "motivation-booster-be598.firebaseapp.com",
                projectId: "motivation-booster-be598",
                storageBucket: "motivation-booster-be598.firebasestorage.app",
                messagingSenderId: "790125844576",
                appId: "1:790125844576:web:7a69934299da7eb5230b05",
                // measurementId is optioneel voor de basisfunctionaliteit
                // measurementId: "G-5855686MXG"
              };

        let app, db, auth;
        let currentUserId = null;
        let isAuthReady = false;
        let ambitions = []; // Lokale cache van ambities

        // DOM-elementen
        const newAmbitionTextInput = document.getElementById('newAmbitionText');
        const selectedCategorySelect = document.getElementById('selectedCategory');
        const addAmbitionButton = document.getElementById('addAmbitionButton');
        const ambitionError = document.getElementById('ambitionError');
        const ambitionsList = document.getElementById('ambitionsList');
        const chatInput = document.getElementById('chatInput');
        const chatButton = document.getElementById('chatButton');
        const chatButtonText = document.getElementById('chatButtonText');
        const chatSpinner = document.getElementById('chatSpinner');
        const chatResponseContainer = document.getElementById('chatResponseContainer');
        const chatResponseText = document.getElementById('chatResponseText');
        const audioLoadingMessage = document.getElementById('audioLoadingMessage');
        const audioPlayer = document.getElementById('audioPlayer');

        // --- Helper functies voor Audio (PCM naar WAV) ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1; // Mono audio
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Sub-chunk size
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, numChannels, true); // Number of channels
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // Byte rate
            view.setUint16(32, numChannels * bytesPerSample, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample

            // DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true); // Sub-chunk size

            // Write PCM data
            const pcmBytes = new Uint8Array(pcmData.buffer);
            for (let i = 0; i < pcmBytes.length; i++) {
                view.setUint8(44 + i, pcmBytes[i]);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // --- Firebase Initialisatie en Authenticatie ---
        async function initializeFirebase() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // Aanmelden met custom token indien beschikbaar, anders anoniem
                // __initial_auth_token is alleen beschikbaar in de Canvas omgeving.
                // Op GitHub Pages zullen we anoniem aanmelden.
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        // Terugval voor niet-geauthenticeerde gebruikers (bijv. als token mislukt)
                        currentUserId = crypto.randomUUID(); // Genereer een willekeurige ID voor anonieme gebruikers
                    }
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", currentUserId);
                    // Start met luisteren naar ambities zodra authenticatie klaar is
                    listenForAmbitions();
                });
            } catch (err) {
                console.error("Fout bij initialiseren Firebase of authenticatie:", err);
                // Toon een foutmelding aan de gebruiker
                document.body.innerHTML = `<div class="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 text-red-600"><p>Kan de app niet laden. Probeer het later opnieuw. Fout: ${err.message}</p></div>`;
            }
        }

        // --- Firestore Luisteraar voor Ambities ---
        function listenForAmbitions() {
            if (!db || !currentUserId || !isAuthReady) return;

            const ambitionsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/ambitions`);
            // Verwijder orderBy van de Firestore query om indexfouten te voorkomen
            const q = query(ambitionsCollectionRef); 

            onSnapshot(q, (snapshot) => {
                const fetchedAmbitions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Sorteer de ambities nu client-side
                ambitions = fetchedAmbitions.sort((a, b) => {
                    // Sorteer eerst op prioriteit (oplopend)
                    if (a.priority !== b.priority) {
                        return a.priority - b.priority;
                    }
                    // Als prioriteit gelijk is, sorteer dan op createdAt (oplopend)
                    // Zorg ervoor dat createdAt objecten zijn of converteer ze naar datums
                    const dateA = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate() : new Date(0); // Gebruik new Date(0) als fallback
                    const dateB = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateA.getTime() - dateB.getTime();
                });
                renderAmbitions(); // Update de UI
            }, (err) => {
                console.error("Fout bij het ophalen van ambities:", err);
                // Toon een foutmelding aan de gebruiker
                ambitionsList.innerHTML = `<li class="text-red-500 text-center">Kan ambities niet laden.</li>`;
            });
        }

        // --- Renderen van Ambities in de UI ---
        function renderAmbitions() {
            ambitionsList.innerHTML = ''; // Leeg de lijst
            if (ambitions.length === 0) {
                ambitionsList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Nog geen ambities toegevoegd. Begin met het toevoegen van je doelen!</p>`;
                return;
            }

            ambitions.forEach(ambition => {
                const li = document.createElement('li');
                li.className = `flex items-center p-4 rounded-lg shadow-sm transition duration-200 ease-in-out
                    ${ambition.completed ? 'bg-green-50 dark:bg-green-900 border-l-4 border-green-500' : 'bg-gray-50 dark:bg-gray-700 border-l-4 border-indigo-500'}`;
                li.innerHTML = `
                    <input type="checkbox" data-id="${ambition.id}" ${ambition.completed ? 'checked' : ''}
                        class="form-checkbox h-5 w-5 text-indigo-600 dark:text-indigo-400 rounded focus:ring-indigo-500 cursor-pointer">
                    <div class="ml-3 flex-grow">
                        <span class="text-lg ${ambition.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-800 dark:text-gray-200'}">
                            ${ambition.text}
                        </span>
                        ${ambition.category ? `<span class="block text-sm text-gray-500 dark:text-gray-400 mt-1">Categorie: ${ambition.category}</span>` : ''}
                    </div>
                    <input type="number" value="${ambition.priority}" data-id="${ambition.id}"
                        class="w-16 p-2 ml-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        min="1">
                    <button data-id="${ambition.id}"
                        class="ml-4 p-2 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-800 rounded-full transition duration-200 ease-in-out"
                        title="Verwijder ambitie">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                ambitionsList.appendChild(li);

                // Voeg event listeners toe aan de dynamisch gemaakte elementen
                li.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleComplete(e.target.dataset.id, e.target.checked));
                li.querySelector('input[type="number"]').addEventListener('change', (e) => updatePriority(e.target.dataset.id, e.target.value));
                li.querySelector('button').addEventListener('click', (e) => deleteAmbition(e.currentTarget.dataset.id));
            });
        }

        // --- CRUD Operaties voor Ambities ---
        async function addAmbition() {
            const text = newAmbitionTextInput.value.trim();
            const category = selectedCategorySelect.value;

            if (!text || !category || !db || !currentUserId) {
                ambitionError.classList.remove('hidden');
                return;
            }
            ambitionError.classList.add('hidden');

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/ambitions`), {
                    text: text,
                    completed: false,
                    priority: ambitions.length > 0 ? Math.max(...ambitions.map(a => a.priority)) + 1 : 1,
                    category: category,
                    createdAt: new Date(),
                });
                newAmbitionTextInput.value = '';
                selectedCategorySelect.value = '';
            } catch (err) {
                console.error("Fout bij het toevoegen van ambitie:", err);
                ambitionError.textContent = "Kan ambitie niet toevoegen. Probeer opnieuw.";
                ambitionError.classList.remove('hidden');
            }
        }

        async function toggleComplete(id, completed) {
            if (!db || !currentUserId) return;
            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/ambitions`, id), {
                    completed: completed,
                });
            } catch (err) {
                console.error("Fout bij het bijwerken van ambitie:", err);
            }
        }

        async function deleteAmbition(id) {
            if (!db || !currentUserId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/ambitions`, id));
            } catch (err) {
                console.error("Fout bij het verwijderen van ambitie:", err);
            }
        }

        async function updatePriority(id, newPriority) {
            if (!db || !currentUserId) return;
            const parsedPriority = parseInt(newPriority, 10);
            if (isNaN(parsedPriority) || parsedPriority < 1) return;

            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/ambitions`, id), {
                    priority: parsedPriority,
                });
            } catch (err) {
                console.error("Fout bij het bijwerken van prioriteit:", err);
            }
        }

        // --- Virtuele Manager (Gemini API) ---
        async function handleChatWithManager() {
            const input = chatInput.value.trim();
            if (!input) return;

            // UI feedback: laadstatus
            chatButton.disabled = true;
            chatButtonText.classList.add('hidden');
            chatSpinner.classList.remove('hidden');
            chatResponseContainer.classList.add('hidden');
            chatResponseText.textContent = '';
            audioLoadingMessage.classList.add('hidden');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer.src = '';

            try {
                const currentAmbitionsSummary = ambitions.map(amb =>
                    `- ${amb.text} (Categorie: ${amb.category || 'Niet gespecificeerd'}, Prioriteit: ${amb.priority}, Voltooid: ${amb.completed ? 'Ja' : 'Nee'})`
                ).join('\n');

                const prompt = `Je bent een virtuele teamleider/coach. De gebruiker heeft de volgende ambities en voortgang:\n${currentAmbitionsSummary}\n\nDe gebruiker zegt: "${input}".\n\nGeef feedback, stel vragen, of geef suggesties om de gebruiker te helpen met hun motivatie, planning en voortgang. Houd je antwoord beknopt en motiverend.`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                // BELANGRIJK: Voor GitHub Pages moet je hier je EIGEN Gemini API sleutel invullen.
                // Anders werkt de virtuele manager niet.
                const geminiApiKey = "YOUR_GEMINI_API_KEY"; // <-- VERVANG DEZE
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    chatResponseText.textContent = text;
                    chatResponseContainer.classList.remove('hidden');
                    await generateAudio(text); // Genereer ook audio
                } else {
                    chatResponseText.textContent = "Er is een probleem opgetreden bij het genereren van het antwoord. Probeer het opnieuw.";
                    chatResponseContainer.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Fout bij chatten met virtuele manager:", err);
                chatResponseText.textContent = "Er is een fout opgetreden bij het communiceren met de virtuele manager.";
                chatResponseContainer.classList.remove('hidden');
            } finally {
                chatInput.value = ''; // Leeg het invoerveld
                chatButton.disabled = false;
                chatButtonText.classList.remove('hidden');
                chatSpinner.classList.add('hidden');
            }
        }

        async function generateAudio(text) {
            audioLoadingMessage.classList.remove('hidden');
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" } // Gebruik Kore stem
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                // BELANGRIJK: Voor GitHub Pages moet je hier je EIGEN Gemini API sleutel invullen.
                // Anders werkt de gesproken reactie niet.
                const geminiApiKey = "YOUR_GEMINI_API_KEY"; // <-- VERVANG DEZE
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${geminiApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; // Standaard indien niet gevonden

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                } else {
                    console.warn("Geen audio data ontvangen of onverwacht mimeType:", result);
                }
            } catch (err) {
                console.error("Fout bij het genereren van audio:", err);
            } finally {
                audioLoadingMessage.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        window.onload = initializeFirebase; // Start Firebase als de pagina geladen is

        addAmbitionButton.addEventListener('click', addAmbition);
        newAmbitionTextInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addAmbition();
            }
        });
        chatButton.addEventListener('click', handleChatWithManager);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter voor nieuwe regel, Enter voor versturen
                e.preventDefault(); // Voorkom standaard Enter gedrag (nieuwe regel)
                handleChatWithManager();
            }
        });

    </script>
</body>
</html>
