import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from 'firebase/firestore';

// Global variables provided by the Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [ambitions, setAmbitions] = useState([]);
    const [newAmbitionText, setNewAmbitionText] = useState('');
    const [newAmbitionPriority, setNewAmbitionPriority] = useState(1);
    const [chatInput, setChatInput] = useState('');
    const [chatResponse, setChatResponse] = useState('');
    const [isLoadingChat, setIsLoadingChat] = useState(false);
    const chatHistoryRef = useRef([]); // To maintain chat history for context

    useEffect(() => {
        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0 && !db) {
            try {
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const authInstance = getAuth(app);
                setDb(firestore);
                setAuth(authInstance);

                // Listen for auth state changes
                const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        // Sign in anonymously if no user is logged in and no custom token is provided
                        if (!initialAuthToken) {
                            try {
                                const anonUserCredential = await signInAnonymously(authInstance);
                                setUserId(anonUserCredential.user.uid);
                            } catch (error) {
                                console.error("Error signing in anonymously:", error);
                            }
                        }
                    }
                    setIsAuthReady(true); // Auth state is ready
                });

                // Sign in with custom token if provided
                if (initialAuthToken) {
                    signInWithCustomToken(authInstance, initialAuthToken)
                        .catch((error) => {
                            console.error("Error signing in with custom token:", error);
                            // Fallback to anonymous if custom token fails
                            signInAnonymously(authInstance).then(anonUserCredential => setUserId(anonUserCredential.user.uid));
                        });
                }

                return () => unsubscribe();
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }
    }, [db, firebaseConfig, initialAuthToken]);

    useEffect(() => {
        if (db && userId && isAuthReady) {
            const userAmbitionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/ambitions`);
            // Order by priority, then by createdAt for stable sorting
            const q = query(userAmbitionsCollectionRef, orderBy('priority', 'asc'), orderBy('createdAt', 'asc'));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedAmbitions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setAmbitions(fetchedAmbitions);
            }, (error) => {
                console.error("Error fetching ambitions:", error);
            });

            return () => unsubscribe();
        }
    }, [db, userId, isAuthReady]);

    const addAmbition = async () => {
        if (newAmbitionText.trim() === '' || !db || !userId) return;

        try {
            const userAmbitionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/ambitions`);
            await addDoc(userAmbitionsCollectionRef, {
                text: newAmbitionText,
                completed: false,
                priority: parseInt(newAmbitionPriority, 10),
                createdAt: serverTimestamp()
            });
            setNewAmbitionText('');
            setNewAmbitionPriority(1); // Reset priority
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    };

    const toggleAmbitionCompletion = async (id, completed) => {
        if (!db || !userId) return;
        try {
            const ambitionRef = doc(db, `artifacts/${appId}/users/${userId}/ambitions`, id);
            await updateDoc(ambitionRef, {
                completed: !completed
            });
        } catch (e) {
            console.error("Error updating document: ", e);
        }
    };

    const updateAmbitionPriority = async (id, newPriority) => {
        if (!db || !userId) return;
        try {
            const ambitionRef = doc(db, `artifacts/${appId}/users/${userId}/ambitions`, id);
            await updateDoc(ambitionRef, {
                priority: parseInt(newPriority, 10)
            });
        } catch (e) {
            console.error("Error updating priority: ", e);
        }
    };

    const deleteAmbition = async (id) => {
        if (!db || !userId) return;
        try {
            const ambitionRef = doc(db, `artifacts/${appId}/users/${userId}/ambitions`, id);
            await deleteDoc(ambitionRef);
        } catch (e) {
            console.error("Error deleting document: ", e);
        }
    };

    const getGeminiResponse = async () => {
        if (chatInput.trim() === '') return;

        setIsLoadingChat(true);
        setChatResponse(''); // Clear previous response

        // Prepare current ambitions for the AI context
        const currentAmbitionsStatus = ambitions.map(a =>
            `- ${a.text} (Prioriteit: ${a.priority}, Voltooid: ${a.completed ? 'Ja' : 'Nee'})`
        ).join('\n');

        const prompt = `Je bent een motiverende teamleider die feedback geeft op de voortgang van het werk en helpt bij het overwinnen van uitdagingen. De gebruiker werkt veel zelfstandig, heeft weinig monitoring of aansluiting bij andere werkzaamheden, en ervaart lage druk waardoor hij/zij niet altijd volle dagen werkt. Hij/zij mist een teamleider/manager om dingen mee te bespreken.

Huidige ambities en voortgang van de gebruiker:
${currentAmbitionsStatus || 'Geen ambities toegevoegd.'}

De gebruiker heeft zojuist gezegd: "${chatInput}".

Geef een ondersteunend, constructief en actiegericht antwoord, gericht op het verbeteren van motivatie, het aanpakken van gebrek aan monitoring/aansluiting, en het stimuleren van productiviteit. Houd het beknopt en praktisch. Stel eventueel een vervolgvraag of geef een concrete suggestie.`;

        chatHistoryRef.current.push({ role: "user", parts: [{ text: chatInput }] });

        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
                // You can adjust temperature for creativity vs. focus
                temperature: 0.7,
            }
        };

        const apiKey = ""; // Canvas will provide this at runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let retries = 0;
        const maxRetries = 5;
        const baseDelay = 1000; // 1 second

        while (retries < maxRetries) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429) { // Too Many Requests
                        const delay = baseDelay * Math.pow(2, retries);
                        console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        retries++;
                        continue;
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    setChatResponse(text);
                    chatHistoryRef.current.push({ role: "model", parts: [{ text: text }] });
                } else {
                    setChatResponse("Sorry, ik kon geen antwoord genereren. Probeer het opnieuw.");
                }
                break; // Exit loop on success
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                setChatResponse("Er is een fout opgetreden bij het communiceren met de AI. Probeer het later opnieuw.");
                break; // Exit loop on non-retryable error
            } finally {
                setIsLoadingChat(false);
            }
        }
    };

    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <p className="text-lg text-gray-700">Laden van de applicatie...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-sans flex flex-col items-center">
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

            <style>
                {`
                body {
                    font-family: 'Inter', sans-serif;
                }
                .scroll-container {
                    max-height: 400px; /* Adjust as needed */
                    overflow-y: auto;
                }
                `}
            </style>

            <div className="w-full max-w-4xl bg-white rounded-lg shadow-xl p-6 sm:p-8">
                <h1 className="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">Mijn Motivatie Tracker</h1>
                <p className="text-center text-gray-600 mb-8">Welkom, gebruiker {userId ? userId.substring(0, 8) + '...' : 'onbekend'}. Hier kun je je ambities bijhouden en feedback krijgen van je virtuele teamleider!</p>

                {/* Add Ambition Section */}
                <div className="mb-8 p-6 bg-blue-50 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-blue-800 mb-4">Nieuwe Ambitie Toevoegen</h2>
                    <div className="flex flex-col sm:flex-row gap-4">
                        <input
                            type="text"
                            placeholder="Mijn nieuwe ambitie..."
                            value={newAmbitionText}
                            onChange={(e) => setNewAmbitionText(e.target.value)}
                            className="flex-grow p-3 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <input
                            type="number"
                            placeholder="Prioriteit (1-10)"
                            value={newAmbitionPriority}
                            onChange={(e) => setNewAmbitionPriority(e.target.value)}
                            min="1"
                            max="10"
                            className="w-full sm:w-32 p-3 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <button
                            onClick={addAmbition}
                            className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-300 shadow-lg"
                        >
                            Voeg Toe
                        </button>
                    </div>
                </div>

                {/* Ambitions List Section */}
                <div className="mb-8 p-6 bg-green-50 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-green-800 mb-4">Mijn Ambities</h2>
                    {ambitions.length === 0 ? (
                        <p className="text-gray-600">Nog geen ambities toegevoegd. Voeg er hierboven een toe!</p>
                    ) : (
                        <div className="scroll-container">
                            {ambitions.map((ambition) => (
                                <div
                                    key={ambition.id}
                                    className={`flex items-center justify-between p-4 mb-3 rounded-lg shadow-sm transition duration-200 ease-in-out
                                        ${ambition.completed ? 'bg-green-100 border-l-4 border-green-500 line-through text-gray-500' : 'bg-white border-l-4 border-blue-400'}`}
                                >
                                    <div className="flex items-center flex-grow">
                                        <input
                                            type="checkbox"
                                            checked={ambition.completed}
                                            onChange={() => toggleAmbitionCompletion(ambition.id, ambition.completed)}
                                            className="form-checkbox h-5 w-5 text-blue-600 rounded mr-4"
                                        />
                                        <span className={`text-lg ${ambition.completed ? 'text-gray-500' : 'text-gray-800'}`}>
                                            {ambition.text}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm font-medium text-gray-600 mr-2">Prio:</span>
                                        <input
                                            type="number"
                                            value={ambition.priority}
                                            onChange={(e) => updateAmbitionPriority(ambition.id, e.target.value)}
                                            min="1"
                                            max="10"
                                            className="w-16 p-2 border border-gray-300 rounded-md text-center focus:outline-none focus:ring-1 focus:ring-blue-500"
                                        />
                                        <button
                                            onClick={() => deleteAmbition(ambition.id)}
                                            className="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 shadow-sm"
                                        >
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Virtual Team Leader Section */}
                <div className="p-6 bg-purple-50 rounded-lg shadow-md">
                    <h2 className="text-2xl font-semibold text-purple-800 mb-4">Je Virtuele Teamleider</h2>
                    <div className="bg-white p-4 rounded-md border border-purple-200 mb-4 h-40 overflow-y-auto scroll-container">
                        {chatResponse ? (
                            <p className="text-gray-700 whitespace-pre-wrap">{chatResponse}</p>
                        ) : (
                            <p className="text-gray-500 italic">Stel je teamleider een vraag over je voortgang of motivatie!</p>
                        )}
                        {isLoadingChat && (
                            <div className="flex justify-center items-center mt-4">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
                                <span className="ml-2 text-purple-600">De teamleider denkt na...</span>
                            </div>
                        )}
                    </div>
                    <div className="flex flex-col sm:flex-row gap-4">
                        <input
                            type="text"
                            placeholder="Vraag je teamleider om advies..."
                            value={chatInput}
                            onChange={(e) => setChatInput(e.target.value)}
                            onKeyPress={(e) => { if (e.key === 'Enter') getGeminiResponse(); }}
                            className="flex-grow p-3 border border-purple-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            disabled={isLoadingChat}
                        />
                        <button
                            onClick={getGeminiResponse}
                            className="px-6 py-3 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition duration-300 shadow-lg"
                            disabled={isLoadingChat}
                        >
                            Vraag Advies
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

export default App;
